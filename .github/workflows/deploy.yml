name: Deploy (rsync)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_PROD_HOST: ${{ secrets.SSH_PROD_HOST }}
      SSH_PROD_USER: ${{ secrets.SSH_PROD_USER }}
      SSH_PROD_PASSWORD: ${{ secrets.SSH_PROD_PASSWORD }}
      SSH_PROD_FOLDER: ${{ secrets.SSH_PROD_FOLDER }}
    steps:
      - uses: actions/checkout@v4

      - name: Install rsync + sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync sshpass

      - name: Sync files to server
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          sshpass -p "$SSH_PROD_PASSWORD" rsync -az --no-times --no-perms --no-owner --no-group --omit-dir-times --delete \
            --exclude-from=deploy/rsync-exclude.txt \
            -e "ssh $SSH_OPTS" \
            ./ "$SSH_PROD_USER@$SSH_PROD_HOST:$SSH_PROD_FOLDER"

      - name: Build & clear caches on server
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          sshpass -p "$SSH_PROD_PASSWORD" ssh $SSH_OPTS "$SSH_PROD_USER@$SSH_PROD_HOST" "
            cd $SSH_PROD_FOLDER \
            && composer install --no-dev --optimize-autoloader \
            && if command -v yarn >/dev/null 2>&1 && [ -f yarn.lock ]; then yarn install --frozen-lockfile && yarn build; \
               elif [ -f package-lock.json ]; then npm ci && npm run build; \
               else npm install && npm run build; fi \
            && php artisan migrate --force \
            && php artisan storage:link || true \
            && php artisan config:clear \
            && php artisan route:clear \
            && php artisan config:cache \
            && php artisan route:cache
          "

      - name: Notify Risklog
        env:
          RISKLOG_API_KEY: ${{ secrets.RISKLOG_API_KEY }}
          RISKLOG_PROJECT_SLUG: ${{ secrets.RISKLOG_PROJECT_SLUG }}
          RISKLOG_ENVIRONMENT: ${{ secrets.RISKLOG_ENVIRONMENT }}
        run: |
          commit_time="$(git show -s --format=%cI "$GITHUB_SHA")"  # ISO 8601 do commit
          payload=$(cat <<EOF
          {
            "project_slug": "${RISKLOG_PROJECT_SLUG}",
            "environment": "${RISKLOG_ENVIRONMENT}",
            "pipeline_id": "github:actions:${{ github.run_id }}",
            "pipeline_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "status": "succeeded",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "author_name": "${{ github.actor }}",
            "author_email": "${{ github.event.head_commit.author.email }}",
            "triggered_by": "github-actions",
            "branch": "${{ github.ref_name }}",
            "repository": "${{ github.repository }}",
            "started_at": "${commit_time}",
            "finished_at": "${commit_time}"
          }
          EOF
          )
          curl -X POST "https://app.startup.dev.br/api/ingest/deploy" \
            -H "X-Api-Key: $RISKLOG_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$payload"
